# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0

name                nsis
version             3.01
categories          devel
license             zlib CPL-1 MIT
platforms           darwin
maintainers         nomaintainer

description         NSIS is a tool for creating win32 installers.
long_description    NSIS (Nullsoft Scriptable Install System) is a tool \
                    that allows programmers to create software installers \
                    for Windows. It is released under an open source \
                    license and is completely free for any use.

homepage            http://nsis.sourceforge.net/
master_sites        sourceforge

distname            ${name}-${version}-src
use_bzip2           yes

distfiles-append    nsis-${version}.zip
extract.only-delete nsis-${version}.zip

checksums           nsis-${version}-src.tar.bz2 \
                    rmd160  9674b933a3d0df881a441d3caf2119dae5cbff20 \
                    sha256  604c011593be484e65b2141c50a018f1b28ab28c994268e4ecd377773f3ffba1 \
                    nsis-${version}.zip \
                    rmd160  6a6193c61d6c59adc6384dd268ea160571b6933b \
                    sha256  daa17556c8690a34fb13af25c87ced89c79a36a935bf6126253a9d9a5226367c

depends_build       port:scons

# Installer checks for cross-compiler during build, but doesn't seem to use it?
#                   port:i386-mingw32-gcc

post-extract {
    system -W ${workpath} "unzip ${distpath}/nsis-${version}.zip"
}

use_configure       no

# nsis can only ever be built 32-bit, but relies on libiconv. Since the
# dependency is limited to only iconv, we will rely on the base system
# 32-bit libiconv installation. Should MacPorts switch to 32-bit/64-bit
# universal builds by default, this decision should be revisited.
set scons.args      "PREFIX=\"${prefix}\" CC=\"${configure.cc}\" CXX=\"${configure.cxx}\" \
                    APPEND_CCFLAGS=\"-stdlib=${configure.cxx_stdlib}\" APPEND_LINKFLAGS=\"-stdlib=${configure.cxx_stdlib}\" \
                    STRIP=0 SKIPSTUBS=all SKIPPLUGINS=all SKIPUTILS=all SKIPMISC=all"
#                   APPEND_CPPPATH=\"${prefix}/include\" APPEND_LIBPATH=\"${prefix}/lib\"

# just an ugly hack to remove "-j<n>"
use_parallel_build  no

build.cmd           scons
build.args          ${scons.args}
build.target

destroot.args       ${scons.args}
destroot.target     install
destroot.destdir    "PREFIX_DEST=\"${destroot}\""

post-destroot {
    foreach dir {Bin Contrib Docs Examples Include Menu Plugins Stubs} {
        file delete -force ${destroot}${prefix}/share/nsis/${dir}
        file copy ${workpath}/nsis-${version}/${dir} ${destroot}${prefix}/share/nsis
    }
    system "chmod -R go-w '${destroot}${prefix}/share/nsis'"
}
